<script>
    // 게임 요소들
    let player = document.getElementById('player');
    let gameContainer = document.getElementById('gameContainer');
    let coordinates = document.getElementById('coordinates');
    let gameStats = document.getElementById('gameStats');
    
    // 게임 설정
let gameWidth = window.innerWidth;
let gameHeight = window.innerHeight;
    const playerSize = 40;
    const groundHeight = 80;
    
    // 플레이어 상태
    let playerX = 100;
    let playerY = gameHeight - groundHeight - playerSize;
    let velocityX = 0;
    let velocityY = 0;
    
    // 게임 설정 (구글 시트에서 가져올 값들)
    let moveSpeed = 7;
    let jumpPower = 15;
    let gravity = 0.6;
    let friction = 0.8;
    let airResistance = 0.95;
    let bulletSpeed = 10;
    let fireRate = 300; // 밀리초
    
    // 주사위 관련 변수
    let diceArray = [];
    let diceShot = 0;
    let totalDamage = 0;
    let lastFireTime = 0;

    // 적 관련 변수 (새로 추가)
    let enemies = [];
    let damageIndicators = [];
    
    // 입력 상태
    let keys = {
    left: false,
    right: false,
    jump: false,
    shoot: false,
    arrowLeft: false,
    arrowRight: false,
    arrowUp: false,
    arrowDown: false
};
    
    let isOnGround = false;
    //게임 루프
    function gameLoop() {
    handleInput();
    updatePhysics();
    updateDice();
    updateEnemies();          // 추가
    updateDamageIndicators(); // 추가
    checkDiceEnemyCollisions(); // 추가
    updatePlayerPosition();
    updateUI();
    requestAnimationFrame(gameLoop);
}
    
    // 입력 처리
    // 입력 처리
function handleInput() {
    // 좌우 이동 (땅에서 더 빠르게)
    if (keys.left) {
        if (isOnGround) {
            velocityX -= moveSpeed * 1.0; // 땅에서 더 빠름
        } else {
            velocityX -= moveSpeed * 0.1;  // 공중에서는 기존대로
        }
    }
    if (keys.right) {
        if (isOnGround) {
            velocityX += moveSpeed * 0.15; // 땅에서 더 빠름
        } else {
            velocityX += moveSpeed * 0.1;  // 공중에서는 기존대로
        }
    }
    
    // 점프 (땅에 있을 때만)
    if (keys.jump && isOnGround) {
        velocityY = -jumpPower;
        isOnGround = false;
    }
    
    // 주사위 발사 (S키)
    if (keys.shoot) {
        fireDice(); // 기본 우측 발사
    }
    
    // 화살표키로 방향 발사
    if (keys.arrowLeft) {
        fireDice(-1, 0); // 왼쪽
    }
    if (keys.arrowRight) {
        fireDice(1, 0); // 오른쪽
    }
    if (keys.arrowUp) {
        fireDice(0, -1); // 위쪽
    }
    if (keys.arrowDown) {
        fireDice(0, 1); // 아래쪽
    }
}

    // 주사위 눈 생성 함수 - 개선된 버전
    function createDiceFace(value) {
        let dotsHTML = '';
        
        // 주사위 눈에 따라 점 생성
        for (let i = 0; i < value; i++) {
            dotsHTML += '<div class="dice-dot"></div>';
        }
        
        return dotsHTML;
    }

    // 주사위 발사 함수
    function fireDice(directionX = 1, directionY = 0) {
    const currentTime = Date.now();
    if (currentTime - lastFireTime < fireRate) return;
    
    lastFireTime = currentTime;
    diceShot++;


// 허수아비 생성 함수 (기존 함수들 뒤에 추가)
function createTrainingDummy() {
    const dummy = {
        element: document.createElement('div'),
        x: gameWidth - 200,
        y: gameHeight - groundHeight - 60,
        width: 40,
        height: 60,
        maxHp: 1000,
        currentHp: 1000,
        type: 'dummy'
    };
    
    dummy.element.className = 'training-dummy';
    dummy.element.style.left = dummy.x + 'px';
    dummy.element.style.top = dummy.y + 'px';
    
    const hpBar = document.createElement('div');
    hpBar.className = 'enemy-hp-bar';
    hpBar.innerHTML = `
        <div class="hp-bar-background">
            <div class="hp-bar-fill"></div>
            <div class="hp-bar-text">${dummy.currentHp}/${dummy.maxHp}</div>
        </div>
    `;
    dummy.element.appendChild(hpBar);
    
    gameContainer.appendChild(dummy.element);
    enemies.push(dummy);
}

// 적 업데이트 함수
function updateEnemies() {
    enemies.forEach(enemy => {
        if (enemy.type === 'dummy') {
            const hpFill = enemy.element.querySelector('.hp-bar-fill');
            const hpText = enemy.element.querySelector('.hp-bar-text');
            
            const hpPercent = (enemy.currentHp / enemy.maxHp) * 100;
            hpFill.style.width = hpPercent + '%';
            hpText.textContent = `${enemy.currentHp}/${enemy.maxHp}`;
        }
    });
}

// 데미지 표시기 생성
function createDamageIndicator(x, y, diceValue) {
    const indicator = {
        element: document.createElement('div'),
        x: x,
        y: y - 30,
        life: 180,
        diceValue: diceValue
    };
    
    indicator.element.className = 'damage-indicator';
    indicator.element.textContent = diceValue;
    indicator.element.style.left = indicator.x + 'px';
    indicator.element.style.top = indicator.y + 'px';
    
    gameContainer.appendChild(indicator.element);
    damageIndicators.push(indicator);
}

// 데미지 표시기 업데이트
function updateDamageIndicators() {
    for (let i = damageIndicators.length - 1; i >= 0; i--) {
        const indicator = damageIndicators[i];
        
        indicator.life--;
        
        if (indicator.life < 60) {
            const opacity = indicator.life / 60;
            indicator.element.style.opacity = opacity;
        }
        
        if (indicator.life <= 0) {
            indicator.element.remove();
            damageIndicators.splice(i, 1);
        }
    }
}

// 주사위와 적 충돌 검사
function checkDiceEnemyCollisions() {
    for (let i = diceArray.length - 1; i >= 0; i--) {
        const dice = diceArray[i];
        
        for (let j = 0; j < enemies.length; j++) {
            const enemy = enemies[j];
            
            if (dice.x < enemy.x + enemy.width &&
                dice.x + 25 > enemy.x &&
                dice.y < enemy.y + enemy.height &&
                dice.y + 25 > enemy.y) {
                
                enemy.currentHp -= dice.value;
                if (enemy.currentHp < 0) enemy.currentHp = 0;
                
                createDamageIndicator(enemy.x + enemy.width / 2, enemy.y, dice.value);
                
                dice.element.remove();
                diceArray.splice(i, 1);
                break;
            }
        }
    }
}

    // 주사위 생성
    const dice = {
        element: document.createElement('div'),
        x: playerX + playerSize / 2,
        y: playerY + playerSize / 2,
        velocityX: bulletSpeed * directionX,
        velocityY: bulletSpeed * directionY,
        value: Math.floor(Math.random() * 6) + 1,
        life: 300,
        rollCounter: 0
    };
        
        // 주사위 요소 설정
        dice.element.className = `dice dice-face-${dice.value}`;
        dice.element.innerHTML = createDiceFace(dice.value);
        dice.element.style.left = dice.x + 'px';
        dice.element.style.top = dice.y + 'px';
        
        gameContainer.appendChild(dice.element);
        diceArray.push(dice);
        
        totalDamage += dice.value;
    }
    
    // 주사위 업데이트
    function updateDice() {
        for (let i = diceArray.length - 1; i >= 0; i--) {
            const dice = diceArray[i];
            
            // 주사위 이동
            dice.x += dice.velocityX;
            dice.y += dice.velocityY;
            
            // 주사위 눈 랜덤 변경 (더 안정적으로)
            dice.rollCounter++;
            if (dice.rollCounter % 40 === 0) { // 20프레임마다 변경 (더 천천히)
                const oldValue = dice.value;
                dice.value = Math.floor(Math.random() * 6) + 1;
                
                // 값이 바뀌었을 때만 업데이트
                if (oldValue !== dice.value) {
                    dice.element.className = `dice dice-face-${dice.value}`;
                    dice.element.innerHTML = createDiceFace(dice.value);
                    
                    // 총 데미지 업데이트 (이전 값 빼고 새 값 더하기)
                    totalDamage = totalDamage - oldValue + dice.value;
                }
            }
            
            // 위치 업데이트
            dice.element.style.left = dice.x + 'px';
            dice.element.style.top = dice.y + 'px';
            
            // 수명 감소
            dice.life--;
            
            // 화면 밖으로 나가거나 수명이 다하면 제거
            if (dice.x > gameWidth || dice.y > gameHeight || dice.life <= 0) {
                dice.element.remove();
                diceArray.splice(i, 1);
            }
        }
    }
    
    // UI 업데이트
    function updateUI() {
        gameStats.textContent = `주사위: ${diceShot}발 | 총 데미지: ${totalDamage}`;
    }
    
    // 물리 엔진
    function updatePhysics() {
        // 중력 적용
        velocityY += gravity;
        
        // 공기 저항
if (!isOnGround) {
    velocityX *= airResistance;
} else {
    // 땅에서의 마찰
    velocityX *= friction;
}
        
        // 최대 속도 제한
        const maxVelocityX = moveSpeed;
        const maxVelocityY = 25;
        
        if (velocityX > maxVelocityX) velocityX = maxVelocityX;
        if (velocityX < -maxVelocityX) velocityX = -maxVelocityX;
        if (velocityY > maxVelocityY) velocityY = maxVelocityY;
        
        // 위치 업데이트
        playerX += velocityX;
        playerY += velocityY;
        
        // 경계 충돌 검사
        checkCollisions();
    }
    
    // 충돌 검사
    function checkCollisions() {
        // 좌우 벽 충돌
        if (playerX < 0) {
            playerX = 0;
            velocityX = 0;
        }
        if (playerX > gameWidth - playerSize) {
            playerX = gameWidth - playerSize;
            velocityX = 0;
        }
        
        // 땅 충돌
        const groundY = gameHeight - groundHeight - playerSize;
        if (playerY >= groundY) {
            playerY = groundY;
            velocityY = 0;
            isOnGround = true;
        } else {
            isOnGround = false;
        }
        
        // 천장 충돌
        if (playerY < 0) {
            playerY = 0;
            velocityY = 0;
        }
    }
    
    // 플레이어 위치 업데이트
    function updatePlayerPosition() {
        player.style.left = Math.round(playerX) + 'px';
        player.style.top = Math.round(playerY) + 'px';
        coordinates.textContent = `X: ${Math.round(playerX)}, Y: ${Math.round(playerY)}`;
    }
    
    // 키보드 이벤트 처리
    document.addEventListener('keydown', function(event) {
    switch(event.key.toLowerCase()) {
        case 'a':
            keys.left = true;
            event.preventDefault();
            break;
        case 'd':
            keys.right = true;
            event.preventDefault();
            break;
        case 'w':
        case ' ':
            keys.jump = true;
            event.preventDefault();
            break;
        case 's':
            keys.shoot = true;
            event.preventDefault();
            break;
        case 'arrowleft':
            keys.arrowLeft = true;
            event.preventDefault();
            break;
        case 'arrowright':
            keys.arrowRight = true;
            event.preventDefault();
            break;
        case 'arrowup':
            keys.arrowUp = true;
            event.preventDefault();
            break;
        case 'arrowdown':
            keys.arrowDown = true;
            event.preventDefault();
            break;
    }
});
    
    document.addEventListener('keyup', function(event) {
    switch(event.key.toLowerCase()) {
        case 'a':
            keys.left = false;
            event.preventDefault();
            break;
        case 'd':
            keys.right = false;
            event.preventDefault();
            break;
        case 'w':
        case ' ':
            keys.jump = false;
            event.preventDefault();
            break;
        case 's':
            keys.shoot = false;
            event.preventDefault();
            break;
        case 'arrowleft':
            keys.arrowLeft = false;
            event.preventDefault();
            break;
        case 'arrowright':
            keys.arrowRight = false;
            event.preventDefault();
            break;
        case 'arrowup':
            keys.arrowUp = false;
            event.preventDefault();
            break;
        case 'arrowdown':
            keys.arrowDown = false;
            event.preventDefault();
            break;
    }
});
    
    // 화면 크기 변경 대응
window.addEventListener('resize', function() {
    gameWidth = window.innerWidth;
    gameHeight = window.innerHeight;
});
    });
    
    // 구글 시트 연동 함수들
    function loadPosition() {
        google.script.run
            .withSuccessHandler(function(data) {
                playerX = data.playerX;
                playerY = data.playerY;
                moveSpeed = data.moveSpeed;
                jumpPower = data.jumpPower;
                gravity = data.gravity;
                
                // 속도 초기화
                velocityX = 0;
                velocityY = 0;
                
                updatePlayerPosition();
                alert('데이터를 불러왔습니다!');
            })
            .withFailureHandler(function(error) {
                alert('데이터를 불러오는데 실패했습니다: ' + error);
            })
            .getGameData();
    }
    
    function savePosition() {
        google.script.run
            .withSuccessHandler(function(result) {
                alert('위치가 저장되었습니다!');
            })
            .withFailureHandler(function(error) {
                alert('저장에 실패했습니다: ' + error);
            })
            .saveGameData(Math.round(playerX), Math.round(playerY));
    }
    
    function resetPosition() {
        google.script.run
            .withSuccessHandler(function(result) {
                playerX = 100;
                playerY = gameHeight - groundHeight - playerSize;
                velocityX = 0;
                velocityY = 0;
                diceShot = 0;
                totalDamage = 0;
                
                // 모든 주사위 제거
                diceArray.forEach(dice => dice.element.remove());
                diceArray = [];
                
                updatePlayerPosition();
                alert('게임이 초기화되었습니다!');
            })
            .withFailureHandler(function(error) {
                alert('초기화에 실패했습니다: ' + error);
            })
            .resetGame();
    }
    
    // 게임 시작
    function startGame() {
    updatePlayerPosition();
    createTrainingDummy(); // 추가
    gameLoop();
}
    
    // 페이지 로드 시 초기화
    window.onload = function() {
        // 게임 설정 로드
        google.script.run
            .withSuccessHandler(function(data) {
                if (data) {
                    moveSpeed = data.moveSpeed || moveSpeed;
                    jumpPower = data.jumpPower || jumpPower;
                    gravity = data.gravity || gravity;
                    bulletSpeed = data.bulletSpeed || bulletSpeed;
                    fireRate = data.fireRate || fireRate;
                }
                startGame();
            })
            .withFailureHandler(function(error) {
                console.log('설정을 불러오는데 실패했지만 기본값으로 시작합니다.');
                startGame();
            })
            .getGameSettings();
    };
</script>
